<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

</head>
<style>
	table {
		background-color: #00f;
		margin: 20px;
		padding: 15px;
	}

	td.case {
		width: 80px;
		height: 80px;
		background-color: #fff;
		border-radius: 50%
	}

	td.case.col_1 {
		background-color: #f00;
	}

	td.case.col_2 {
		background-color: #ff0;
	}

	td.control {
		font-size: 150%;
		color: #00c;
		height: 50px;
		text-align: center;
		cursor: pointer;
		user-select: none;
	}

	td.control:hover {
		font-size: 200%;
		color: #fff;
	}

	tr.disabled td.control {
		visibility: hidden;
	}
</style>

<body class="container">
	<div class="row">
		<div class="col">
			<table id="gameBoard"></table>
			<button id="resetGame">Reset</button>
			<!-- <input id="toggleControls" type="checkbox" name="aquoi" value="çasert">Contrôles</> -->
		</div>
		<div class="col">
			<img src="/static/trollface.png" alt="" srcset="">
		</div>
	</div>
</body>
<script>
	$('img').hide()
	const width = 7;
	const height = 6;

	var player = 1; //(1<->2)
	//Le joueur 1 commence, si sur 3 =spec
	var whoIsPlaying = 3;
	//data
	var data = new Array(width);
	for (let i = 0; i < width; i++) {
		data[i] = [];
	}
	console.log(data);

	//view
	let boardRow = $('<tr id="controls" class=""></tr>');
	for (let i = 0; i < width; i++) {
		$('<td class="control" data-col="' + i + '">&#9660;</td>').click(function () {
			if (whoIsPlaying == player) {
				let col = $(this).attr('data-col');
				let row = data[col].length;
				if (row < height) {
					//on click update data
					data[col].push(player);
					player_plays(data)
				}
			}
			else {
				console.log("not your turn !");
			}
		}).appendTo(boardRow);
	}
	$('#gameBoard').append(boardRow);
	for (let i = 0; i < height; i++) {
		let boardRow = $('<tr></tr>');
		for (let j = 0; j < width; j++) {
			$('<td class="case col_' + data[i][j] + '"></td>').appendTo(boardRow);
		}
		$('#gameBoard').append(boardRow);
	}

	/* ------------------------------------------ */






	//io stuff here
	var socket = io();

	socket.on('player_has_joined', function (n) {
		if (n > 2) {
			console.log("Vous etes spectateur");
			$("#controls").add('disabled');
			$('#resetGame').hide()
		}
		else if(n==1){
			whoIsPlaying = 1;
			console.log("Vous etes le joueur : ", whoIsPlaying);
			$("#controls").removeClass('disabled');
		}
		else if(n==2){
			whoIsPlaying = 2;
			console.log("Vous etes le joueur : ", whoIsPlaying);
			$("#controls").addClass('disabled');
			changeCtrl()
			
		}

	})

	function player_plays(data) {
		socket.emit('player_plays', data,whoIsPlaying)
	}


	socket.on('update_board', function (NewData, joueur) {
		data = NewData
		console.log("update", data);
		if(data!=[]){
		for (var i in data) {
			for (var j in data[i]) {
				//console.log('-->',$('#gameBoard tr:nth('+(6-j)+') td:nth('+(i)+')'));
				$('#gameBoard tr:nth(' + (6 - j) + ') td:nth(' + (i) + ')').addClass("col_" + data[i][j])
				
			}
		}

		player = joueur;}
		
		console.log("tour  -> ",player);

		changeCtrl()
	})

	function changeCtrl() {
		if (player==whoIsPlaying) {
			console.log("A toi de joué");
			$("#controls").removeClass('disabled');
		} else $("#controls").addClass('disabled');


	}
	socket.on('rage_quit', function (n) {
		alert("Player "+n+" has left !")
		$('img').show()
	})

	$('#resetGame').click(function() {
		for (let i=0; i<width; i++) {
			data[i] = []
		}
		player_plays(data)
		socket.emit('restart')
	})

	socket.on('clear',function clearView() {  
		//Clear view
		for (let i = 1; i <= height; i++) {
			for (let j = 0; j < width; j++) {
				$('#gameBoard tr:nth(' + i + ') td:nth(' + j + ')').removeClass("col_1 col_2");
			}
		}})

	
</script>

</html>